<div class="comments-modal-container">
  <h5 class="modal-title mb-3">Comments for: <span class="idea-title">{{ ideaTitle }}</span></h5>
  <div class="comments-list mb-4" *ngIf="topLevelComments.length; else noComments">
    <ng-container *ngFor="let comment of topLevelComments">
      <ng-template [ngTemplateOutlet]="commentThread" [ngTemplateOutletContext]="{ comment: comment }"></ng-template>
    </ng-container>
  </div>
  <ng-template #noComments>
    <div class="no-comments text-muted mb-4">No comments yet. Be the first to comment!</div>
  </ng-template>

  <!-- New Top-Level Comment Form -->
  <form [formGroup]="commentForm" (ngSubmit)="submitComment()" class="reply-form mt-2">
    <textarea
      class="form-control"
      formControlName="content"
      rows="2"
      placeholder="Write a comment...">
    </textarea>
    <div class="d-flex gap-2 mt-1">
      <button type="submit" class="btn btn-primary btn-sm" [disabled]="commentForm.invalid">Publish</button>
    </div>
  </form>

  <!-- Recursive comment thread template -->
  <ng-template #commentThread let-comment="comment">
    <div class="comment-item no-card">
      <div class="comment-header">
        <span class="comment-author">{{ comment.author }}</span>
      </div>
      <div class="comment-content">{{ comment.content }}</div>
      <div class="comment-actions">
        <button class="btn btn-link btn-sm p-0" (click)="startReply(comment.id)">Reply</button>
      </div>
      <!-- Reply form for this comment -->
      <form *ngIf="replyingTo === comment.id" [formGroup]="replyForms[comment.id]" (ngSubmit)="submitReply(comment.id)" class="reply-form mt-2">
        <textarea
          class="form-control"
          formControlName="content"
          rows="2"
          placeholder="Write your reply..."
        ></textarea>
        <div class="d-flex gap-2 mt-1">
<!--          <button type="submit" class="btn btn-primary btn-sm" [disabled]="replyForms[comment.id]?.invalid">Reply</button>-->
          <button type="button" class="btn btn-secondary btn-sm" (click)="cancelReply()">Cancel</button>
        </div>
      </form>
      <!-- Nested replies -->
      <div class="replies ms-4 mt-2" *ngIf="getReplies(comment.id).length">
        <ng-container *ngFor="let reply of getReplies(comment.id)">
          <ng-template [ngTemplateOutlet]="commentThread" [ngTemplateOutletContext]="{ comment: reply }"></ng-template>
        </ng-container>
      </div>
    </div>
  </ng-template>
</div>
